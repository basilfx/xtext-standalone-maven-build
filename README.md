# Xtext Standalone Maven Build

## Introduction
This example [Xtext](https://eclipse.org/Xtext/) project shows you how to create a standalone version of your Xtext DSL compiler, to be used without Eclipse (.e.g in continuous integration environments). The project remains compatible with Eclipse.

Since Xtext 2.9 or newer, it is possible to create a Maven-compatible project. However, it takes your project and uses Eclipse Tycho to manage dependencies using a manifest-first approach. The dependencies are not known to Maven, therefore plugins such as the [Maven Dependency Plugin](https://maven.apache.org/plugins/maven-dependency-plugin/) cannot assemble a runnable (fat) jar.

On the other hand, it is possible to use Eclipse and export the project as a runnable jar. This works, but requires Eclipse to be installed, and is not compatible with build automation tools.

## Solution
In this repository, a solution is provided that comes close to what Eclipse produces when you export your project as a runnable jar. It works as follows:

* Based on a Xtext 2.12 project structure generated by Eclipse with Maven as a build system, we enable the generation of a main method by setting `generateXtendMain = true` in `org.xtext.example.mydsl/src/org/xtext/example/mydsl/GenerateMyDsl.mwe2`.
* The `org.xtext.example.mydsl.standalone` module is then added, which includes a `pom.xml` that is similar to the repository facet. It is configured to collect all dependencies into a single repository folder, `org.xtext.example.mydsl.standalone/target/repository/plugins`.
* Using some build automation, that folder is copied to `org.xtext.example.mydsl.standalone/target/classes/lib`.
* The main artifact (`org.xtext.example.mydsl`) is unpacked into `target/classes`, together with a jar-in-jar loader (see below).
* A custom Groovy script will create a manifest file, listing all the jars in `org.xtext.example.mydsl.standalone/target/classes/lib`.
* The [Maven AntRun Plugin](http://maven.apache.org/plugins/maven-antrun-plugin/) is used to assemble a fat jar in `org.xtext.example.mydsl.standalone/target`.

While this solution is not perfect, it produces a jar that is very similar to what Eclipse produces. You are not required to list all dependencies and dependencies will be isolated.

## How to use
Please check the commit log to see how you can integrate the standalone module. The only change to your parent `pom.xml` is to include the module.

When you have applied this change, run `mvn clean package` to build the fat jar. You can then run it using `java -jar org.xtext.example.mydsl.standalone/target/org.xtext.example.mydsl.standalone-1.0.0-SNAPSHOT.jar`.

### Migrating an existing project
Depending on the original project nature, it is important to add support for Maven. The easiest way is to ensure that the `pom.xml`, `.project` and `.settings/*` files match with this project, by comparing them line-by-line. Then it is easy to integrate the standalone module.

You are not required to have the `org.xtext.example.mydsl.ide`, `org.xtext.example.mydsl.tests`, `org.xtext.example.mydsl.ui` and `org.xtext.example.mydsl.ui.tests` modules to build a standalone version.

### Limitations
The standalone build assumes you use a default Xtext generated project structure. If your project depends on jar files or that you include manually, ensure they reside in the `lib/` folder (on the same level as your `src/` folder), so they will be included when assembling the final jar.

If you have a different project structure, or if you depend on other resources, you can probably workaround the above limitation using additional Maven tasks.

### File encoding
By default, Eclipse generates project structures that match with your platform's file encoding. This may cause problems with your generators, because the Xtend language uses the `«` and `»` characters for formatting. Both characters have different byte representations, depending on whether you have created an Eclipse project in Windows (Windows-1252) or Linux (UTF-8).

This repository is configured (and assumes) UTF-8 encoded source files, in both Eclipse and Maven. If you mix up encodings, you may notice unformatted output produced by your generators (this does not generate a compile error or warning).

## Sources
This solution is based on two other projects.

The first one is [ckulla/xtext-tycho-example](https://github.com/ckulla/xtext-tycho-example/tree/master/releng). Some functionality has been based on this repository, but it simply unpacks all `*.jar` files and merges them. This has the disadvantage of overwriting resources such as `log4j.properties` and `plugin.propertis`, which [will give errors](https://www.eclipse.org/forums/index.php/t/487563/) when trying to run the standalone version.

Another part of the solution is [raisercostin/eclipse-jarinjarloader](https://github.com/raisercostin/eclipse-jarinjarloader). However, you still need to provide a `MANIFEST.MF` that will load all the `*.jar` files.
